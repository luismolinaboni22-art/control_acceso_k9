@app.route('/reports', methods=['GET'])
@login_required
def reports():
    # Filtros
    nombre = request.args.get('nombre','')
    empresa = request.args.get('empresa','')
    desde = request.args.get('desde','')
    hasta = request.args.get('hasta','')

    query = Visitor.query
    if current_user.role != 'superadmin':
        query = query.filter(Visitor.site_id == current_user.site_id)
    if nombre:
        query = query.filter(Visitor.nombre.ilike(f'%{nombre}%'))
    if empresa:
        query = query.filter(Visitor.empresa.ilike(f'%{empresa}%'))
    if desde:
        try:
            query = query.filter(Visitor.hora_entrada >= datetime.fromisoformat(desde))
        except:
            flash('Formato de fecha "desde" inválido', 'warning')
    if hasta:
        try:
            query = query.filter(Visitor.hora_entrada <= datetime.fromisoformat(hasta))
        except:
            flash('Formato de fecha "hasta" inválido', 'warning')

    visitantes = query.order_by(Visitor.hora_entrada.desc()).all()
    return render_template('reports.html', visitantes=visitantes, nombre=nombre, empresa=empresa, desde=desde, hasta=hasta)
