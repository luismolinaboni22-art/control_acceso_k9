# -----------------------------
# REPORTES + EXPORTAR CSV
# -----------------------------
@app.route('/reports', methods=['GET'])
@login_required
def reports():
    # Obtener filtros del formulario o URL
    nombre = request.args.get('nombre', '').strip()
    empresa = request.args.get('empresa', '').strip()
    desde = request.args.get('desde', '').strip()
    hasta = request.args.get('hasta', '').strip()
    export_csv = request.args.get('export', '').strip().lower()

    # Query base
    query = Visitor.query
    if current_user.role != 'superadmin':
        query = query.filter(Visitor.site_id == current_user.site_id)

    # Aplicar filtros
    if nombre:
        query = query.filter(Visitor.nombre.ilike(f'%{nombre}%'))
    if empresa:
        query = query.filter(Visitor.empresa.ilike(f'%{empresa}%'))
    if desde:
        try:
            desde_dt = datetime.fromisoformat(desde)
            query = query.filter(Visitor.hora_entrada >= desde_dt)
        except ValueError:
            flash('Formato de fecha "desde" inválido', 'warning')
    if hasta:
        try:
            hasta_dt = datetime.fromisoformat(hasta)
            query = query.filter(Visitor.hora_entrada <= hasta_dt)
        except ValueError:
            flash('Formato de fecha "hasta" inválido', 'warning')

    visitantes = query.order_by(Visitor.hora_entrada.desc()).all()

    # EXPORTAR CSV
    if export_csv == 'true':
        import io
        import csv

        def generate():
            data = io.StringIO()
            writer = csv.writer(data)
            # Cabecera CSV
            writer.writerow(['Nombre','Empresa','Cédula','Placa','Persona Visitada','Propósito','Hora Entrada','Hora Salida'])
            yield data.getvalue()
            data.seek(0)
            data.truncate(0)
            # Filas de visitantes
            for v in visitantes:
                writer.writerow([
                    v.nombre,
                    v.empresa or '',
                    v.cedula or '',
                    v.placa or '',
                    v.persona_visitada or '',
                    v.proposito or '',
                    v.hora_entrada.strftime('%Y-%m-%d %H:%M:%S') if v.hora_entrada else '',
                    v.hora_salida.strftime('%Y-%m-%d %H:%M:%S') if v.hora_salida else ''
                ])
                yield data.getvalue()
                data.seek(0)
                data.truncate(0)

        return Response(generate(),
                        mimetype='text/csv',
                        headers={"Content-Disposition":"attachment;filename=reportes_visitantes.csv"})

    # Renderizar HTML si no es exportación
    return render_template('reports.html',
                           visitantes=visitantes,
                           nombre=nombre,
                           empresa=empresa,
                           desde=desde,
                           hasta=hasta)
